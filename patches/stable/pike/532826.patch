From c8caebe784a54b96705db0718f7ab00096b65f29 Mon Sep 17 00:00:00 2001
From: Christian Berendt <berendt@betacloud-solutions.de>
Date: Thu, 11 Jan 2018 14:57:40 +0100
Subject: [PATCH] Make custom elasticsearch configuration files possible

Change-Id: I76183db33d7339e8a446bf687cd6e9865a303aac
---

diff --git a/ansible/roles/elasticsearch/tasks/config.yml b/ansible/roles/elasticsearch/tasks/config.yml
index 958f71d..fa626fe 100644
--- a/ansible/roles/elasticsearch/tasks/config.yml
+++ b/ansible/roles/elasticsearch/tasks/config.yml
@@ -31,14 +31,19 @@
     - Restart elasticsearch container
 
 - name: Copying over elasticsearch.yml
+  vars:
+    elasticsearch: "{{ elasticsearch_services.elasticsearch }}"
   template:
     src: "elasticsearch.yml.j2"
-    dest: "{{ node_config_directory }}/{{ item.key }}/{{ item.key }}.yml"
+    dest: "{{ node_config_directory }}/elasticsearch/elasticsearch.yml"
   register: elasticsearch_confs
+  with_first_found:
+    - "{{ node_custom_config }}/elasticsearch/{{ inventory_hostname }}/elasticsearch.yml"
+    - "{{ node_custom_config }}/elasticsearch/elasticsearch.yml"
+    - "elasticsearch.yml.j2"
   when:
-    - inventory_hostname in groups[item.value.group]
-    - item.value.enabled | bool
-  with_dict: "{{ elasticsearch_services }}"
+    - inventory_hostname in groups[elasticsearch.group]
+    - elasticsearch.enabled | bool
   notify:
     - Restart elasticsearch container
 
