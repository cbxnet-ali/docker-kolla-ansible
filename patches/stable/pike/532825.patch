From 089a86a7e0e07d5820431fac7163ba7d65e3170d Mon Sep 17 00:00:00 2001
From: Christian Berendt <berendt@betacloud-solutions.de>
Date: Thu, 11 Jan 2018 14:54:32 +0100
Subject: [PATCH] Make custom kibana configuration files possible

Change-Id: Iedfad564f834504fa1f4bfd935cd735d1d9ee65f
---

diff --git a/ansible/roles/kibana/tasks/config.yml b/ansible/roles/kibana/tasks/config.yml
index 7c19abf..4142956 100644
--- a/ansible/roles/kibana/tasks/config.yml
+++ b/ansible/roles/kibana/tasks/config.yml
@@ -22,14 +22,19 @@
     - Restart kibana container
 
 - name: Copying over Kibana configuration file
+  vars:
+    kibana: "{{ kibana_services.kibana }}"
   template:
-    src: "{{ item.key }}.yml.j2"
-    dest: "{{ node_config_directory }}/{{ item.key }}/{{ item.key }}.yml"
+    src: "kibana.yml.j2"
+    dest: "{{ node_config_directory }}/kibana/kibana.yml"
   register: kibana_confs
+  with_first_found:
+    - "{{ node_custom_config }}/kibana/{{ inventory_hostname }}/kibana.yml"
+    - "{{ node_custom_config }}/kibana/kibana.yml"
+    - "kibana.yml.j2"
   when:
-    - inventory_hostname in groups[item.value.group]
-    - item.value.enabled | bool
-  with_dict: "{{ kibana_services }}"
+    - inventory_hostname in groups[kibana.group]
+    - kibana.enabled | bool
   notify:
     - Restart kibana container
 
